<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        .neon-blue { text-shadow: 0 0 10px #3b82f6; }
        .neon-orange { text-shadow: 0 0 10px #f97316; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <header class="w-full max-w-md flex justify-between items-center py-6">
        <h1 class="text-2xl font-bold tracking-wider">NANO<span class="text-blue-500">TRACKER</span></h1>
        <div id="btStatus" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_red] transition-all duration-500"></div>
    </header>

    <div id="setupScreen" class="w-full max-w-md space-y-6 mt-10 transition-all duration-500">
        <div class="glass-panel p-6 space-y-4">
            <h2 class="text-xl font-bold text-center mb-4">Profil AthlÃ¨te</h2>
            <div>
                <label class="block text-gray-400 text-sm mb-1">Votre Taille (cm)</label>
                <input type="number" id="heightInput" value="175" class="w-full bg-slate-800 text-white rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>
            <div>
                <label class="block text-gray-400 text-sm mb-1">Votre Poids (kg)</label>
                <input type="number" id="weightInput" value="70" class="w-full bg-slate-800 text-white rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>
        </div>

        <button onclick="startApp()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition shadow-[0_0_20px_rgba(37,99,235,0.4)]">
            PRÃŠT Ã€ PARTIR
        </button>
    </div>

    <div id="dashboardScreen" class="hidden w-full max-w-md space-y-6 mt-4 opacity-0 transition-opacity duration-500">
        
        <button id="connectBtn" onclick="connectBluetooth()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg transition animate-pulse">
            ðŸ“¡ DÃ‰MARRER LA SÃ‰ANCE
        </button>

        <div class="glass-panel p-4 text-center border-blue-500/30">
            <p class="text-xs uppercase tracking-widest text-gray-400">DurÃ©e de l'effort</p>
            <p id="timerDisplay" class="text-4xl font-mono font-bold mt-2 text-white">00:00:00</p>
        </div>

        <div class="glass-panel p-8 flex flex-col items-center justify-center relative">
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-900/50 rounded-2xl"></div>
            <p class="text-6xl font-bold text-white z-10 neon-orange" id="calDisplay">0</p>
            <p class="text-orange-400 font-bold uppercase tracking-widest z-10">Calories</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="glass-panel p-5 text-center">
                <p id="stepDisplay" class="text-3xl font-bold text-green-400">0</p>
                <p class="text-xs text-gray-400 uppercase mt-1">Pas</p>
            </div>
            <div class="glass-panel p-5 text-center">
                <p id="distDisplay" class="text-3xl font-bold text-cyan-400">0.00</p>
                <p class="text-xs text-gray-400 uppercase mt-1">Km</p>
            </div>
        </div>
    </div>

    <script>
        // --- DONNÃ‰ES UTILISATEUR ---
        let userHeight = 175;
        let userWeight = 70;
        let strideLength = 0.72;

        // --- VARIABLES CHRONO ---
        let startTime;
        let timerInterval;
        let isRunning = false;

        // --- UUIDs ---
        const serviceUUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const stepCharUUID = "19b10001-e8f2-537e-4f6c-d104768a1214";

        function startApp() {
            userHeight = parseFloat(document.getElementById('heightInput').value);
            userWeight = parseFloat(document.getElementById('weightInput').value);
            strideLength = (userHeight * 0.415) / 100;

            const setupDiv = document.getElementById('setupScreen');
            const dashboardDiv = document.getElementById('dashboardScreen');

            setupDiv.style.opacity = '0';
            setTimeout(() => {
                setupDiv.classList.add('hidden');
                dashboardDiv.classList.remove('hidden');
                setTimeout(() => dashboardDiv.style.opacity = '1', 50);
            }, 500);
        }

        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUUID] }]
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await device.gatt.connect();
                
                // UI ConnectÃ©
                document.getElementById('btStatus').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_lime]";
                document.getElementById('connectBtn').classList.add('hidden');

                const service = await server.getPrimaryService(serviceUUID);
                const stepChar = await service.getCharacteristic(stepCharUUID);
                
                await stepChar.startNotifications();
                stepChar.addEventListener('characteristicvaluechanged', updateFitnessData);

                // DÃ‰MARRER LE CHRONO
                startTimer();

            } catch (error) {
                console.error(error);
                alert("Erreur connexion : " + error);
            }
        }

        function onDisconnected() {
            // ArrÃªt du chrono et reset UI
            stopTimer();
            document.getElementById('btStatus').className = "w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_red]";
            document.getElementById('connectBtn').classList.remove('hidden');
            document.getElementById('connectBtn').innerText = "RECONNECTER";
            alert("Connexion perdue !");
        }

        // --- GESTION DU CHRONOMÃˆTRE ---
        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                document.getElementById('timerDisplay').innerText = formatTime(elapsedTime);
            }, 1000);
        }

        function stopTimer() {
            isRunning = false;
            clearInterval(timerInterval);
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        function pad(val) {
            return val.toString().padStart(2, '0');
        }

        // --- GESTION DES DONNÃ‰ES SPORT ---
        function updateFitnessData(event) {
            const value = event.target.value;
            const steps = value.getInt32(0, true);

            const distanceKm = (steps * strideLength) / 1000;
            const calories = userWeight * distanceKm * 1.036;

            document.getElementById('stepDisplay').innerText = steps;
            document.getElementById('distDisplay').innerText = distanceKm.toFixed(3);
            document.getElementById('calDisplay').innerText = calories.toFixed(1);
        }
    </script>
</body>
</html>